<style>
#wps_popup,
.data-wps-popup-content-body.bordered,
.wps-overlay-close-button {
  display: none !important;
}
  
</style>

<script>
  
  (function() {
  var buttonId = 'universal-cart-popup-btn';
  var popupId = 'universal-cart-popup';
  var listId = 'universal-cart-popup-list';
  var closeId = 'universal-cart-popup-close';
  var recsButtonId = 'universal-cart-recs-btn';
  var recsContainerId = 'cart-recs';
  var recsTemplateId = 'cart-template';

  // --- UI Elements ---
  if (!document.getElementById(buttonId)) {
    var btn = document.createElement('button');
    btn.id = buttonId;
    btn.textContent = 'View Cart Items';
    btn.style = 'position:fixed;bottom:32px;right:32px;z-index:10000;padding:16px 24px;border-radius:40px;background:#222;color:#fff;border:none;box-shadow:0 2px 10px rgba(0,0,0,0.15);cursor:pointer;display:none;';
    document.body.appendChild(btn);
  }
  if (!document.getElementById(popupId)) {
    var popup = document.createElement('div');
    popup.id = popupId;
    popup.style = 'display:none;position:fixed;bottom:90px;right:32px;z-index:10000;background:#fff;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.2);max-width:350px;width:90vw;padding:24px 16px;max-height:400px;overflow-y:auto;';
    popup.innerHTML =
      `<span id="${closeId}" style="position:absolute;top:8px;right:12px;cursor:pointer;font-weight:bold;font-size:22px;">&times;</span>
      <h3 style="margin-top:0;">Your Cart Items</h3>
      <div id="cart-viewer" style="font-size:12px;color:#888;margin-bottom:8px;"></div>
      <ul id="${listId}" style="list-style:none;padding:0;margin:0;"></ul>
      <button id="${recsButtonId}" style="margin:16px 0 0 0;background:#0070f3;color:#fff;border:none;border-radius:40px;padding:12px 20px;cursor:pointer;width:100%;">Show Cart Recs</button>
      <div id="${recsContainerId}" style="margin-top: 20px; display: none;"></div>`;
    document.body.appendChild(popup);
  }
  if (!document.getElementById(recsTemplateId)) {
    var tpl = document.createElement('script');
    tpl.type = 'text/html';
    tpl.id = recsTemplateId;
    tpl.innerHTML = `
      <![CDATA[
      {{ if (SC.page.products.length) { }}
        <h4>You may need these too</h4>
        <ul style="padding-left:0;list-style:none;">
          {{ for (var i=0; i < SC.page.products.length; i++) { }}
            {{ var p = SC.page.products[i]; }}
            <li style="margin:0 0 1em 0;">
              <a href="{{= p.link }}"><img src="{{= p.image }}" style="height:48px;vertical-align:middle;margin-right:8px;border-radius:4px;"> {{= p.title }}</a>
            </li>
          {{ } }}
        </ul>
      {{ } }}
      ]]>`;
    document.body.appendChild(tpl);
  }

  // --- Viewer (who am I) ---
  function getEmarsysViewer() {
    try {
      var url = new URL(window.location.href);
      var sc_customer = url.searchParams.get('sc_customer');
      var sc_eh = url.searchParams.get('sc_eh');
      if (sc_customer) return {type: 'CustomerID', value: sc_customer};
      if (sc_eh) return {type: 'EmailHash', value: sc_eh};
    } catch(e){}
    try {
      var ci = JSON.parse(localStorage.getItem('_wp_ci_2'));
      if (ci && ci.value) return {type: 'CustomerID', value: ci.value};
    } catch(e){}
    try {
      var eh = JSON.parse(localStorage.getItem('_wp_eh_2'));
      if (eh && eh.value) return {type: 'EmailHash', value: eh.value};
    } catch(e){}
    return null;
  }
  function showViewerInPopup() {
    var viewer = getEmarsysViewer();
    var el = document.getElementById('cart-viewer');
    if (el) {
      el.textContent = viewer
        ? ('Viewing as: ' + viewer.type + ' = ' + viewer.value)
        : 'Viewing as: Guest';
    }
  }

  // --- MAGENTO extraction ---
  function extractMagentoMiniCart() {
    var html = '';
    var seen = new Set();
    jQuery('ol.minicart-items li.item.product.product-item').each(function() {
      var $item = jQuery(this);
      var name = $item.find('.product-item-name a').first().text().trim();
      var url = $item.find('.product-item-name a').first().attr('href') || '#';
      var img = $item.find('.product-image-photo').first().attr('src') || '';
      var price = $item.find('.minicart-price .price').first().text().trim() || 'N/A';
      var qty = $item.find('input.item-qty, input.cart-item-qty').first().val() ||
                $item.find('[data-item-qty]').attr('data-item-qty') ||
                $item.find('.qty').first().text().trim() || '1';
      var uniqueKey = url + '|' + name;
      if (!seen.has(uniqueKey) && name) {
        html += `<li style="margin:1em 0;border-bottom:1px solid #eee;padding-bottom:1em;">`;
        if (img) html += `<img src="${img}" alt="${name}" style="width:48px;height:48px;vertical-align:middle;margin-right:1em;border-radius:4px;">`;
        html += `<strong><a href="${url}" target="_blank" style="color:#333;text-decoration:none;">${name}</a></strong><br>`;
        html += `Price: ${price}<br>`;
        html += `Qty: ${qty}<br>`;
        html += `</li>`;
        seen.add(uniqueKey);
      }
    });
    return html;
  }
  // --- SFCC extraction ---
  function extractSFCCCart() {
    var html = '';
    var seen = new Set();
    jQuery('.product-list-item-custom.product-list-item').each(function() {
      var $item = jQuery(this);
      var name = $item.find('.name a').text().trim();
      var url = $item.find('.name a').attr('href') || '#';
      var img = $item.find('img').attr('src') || '';
      var alt = $item.find('img').attr('alt') || name;
      var price = $item.find('.price, .cart-product-price, .mini-bag-product-price').first().text().trim();
      if (!price) price = $item.find('[class*=price]').first().text().trim();
      if (!price) price = 'N/A';
      var qty = $item.find('.quantity, .mini-bag-product-qty, .cart-product-qty').first().text().trim();
      if (!qty) qty = $item.find('input.qty, input.quantity').val();
      if (!qty || isNaN(qty)) qty = '1';
      var uniqueKey = url + '|' + name;
      if (!seen.has(uniqueKey) && name) {
        html += '<li style="margin:1em 0;border-bottom:1px solid #eee;padding-bottom:1em;">';
        if (img) html += '<img src="' + img + '" alt="' + alt + '" style="width:48px;height:48px;vertical-align:middle;margin-right:1em;border-radius:4px;">';
        html += '<strong><a href="' + url + '" target="_blank" style="color:#333;text-decoration:none;">' + name + '</a></strong><br>';
        html += 'Price: ' + price + '<br>';
        html += 'Qty: ' + qty + '<br>';
        html += '</li>';
        seen.add(uniqueKey);
      }
    });
    // Also check for .mini-cart-product/.mini-bag-product
    jQuery('.mini-cart-product, .mini-bag-product').each(function() {
      var $item = jQuery(this);
      var name = $item.find('.mini-bag-name-value, .mini-cart-name-value').text().trim();
      var url = $item.find('a').attr('href') || '#';
      var img = $item.find('img').attr('src') || '';
      var alt = $item.find('img').attr('alt') || name;
      var price = $item.find('.mini-bag-product-price, .price, .cart-product-price').first().text().trim();
      if (!price) price = $item.find('[class*=price]').first().text().trim();
      if (!price) price = 'N/A';
      var qty = $item.find('.mini-bag-product-qty, .quantity, .cart-product-qty').first().text().trim();
      if (!qty) qty = $item.find('input.qty, input.quantity').val();
      if (!qty || isNaN(qty)) qty = '1';
      var uniqueKey = url + '|' + name;
      if (!seen.has(uniqueKey) && name) {
        html += '<li style="margin:1em 0;border-bottom:1px solid #eee;padding-bottom:1em;">';
        if (img) html += '<img src="' + img + '" alt="' + alt + '" style="width:48px;height:48px;vertical-align:middle;margin-right:1em;border-radius:4px;">';
        html += '<strong><a href="' + url + '" target="_blank" style="color:#333;text-decoration:none;">' + name + '</a></strong><br>';
        html += 'Price: ' + price + '<br>';
        html += 'Qty: ' + qty + '<br>';
        html += '</li>';
        seen.add(uniqueKey);
      }
    });
    return html;
  }
  // --- Universal Extraction ---
  function extractCartItemsUniversal() {
    var html = '';
    html = extractMagentoMiniCart();
    if (html) return html;
    html = extractSFCCCart();
    if (html) return html;
    return '';
  }

  // --- ScarabQueue Extraction ---
  function extractCartItemsForScarab() {
    var items = [];
    jQuery('ol.minicart-items li.item.product.product-item').each(function() {
      var $item = jQuery(this);
      var id = $item.data('product-id') || $item.find('[data-product-id]').attr('data-product-id') || '';
      var price = $item.find('.minicart-price .price').first().text().replace(/[^\d\.,]/g, '').replace(',', '') || '';
      var qty = $item.find('input.item-qty, input.cart-item-qty').first().val() ||
                $item.find('[data-item-qty]').attr('data-item-qty') ||
                $item.find('.qty').first().text().trim() || '1';
      if (id) {
        items.push({
          item: id,
          price: parseFloat(price) || 0,
          quantity: parseInt(qty, 10) || 1
        });
      }
    });
    jQuery('.product-list-item-custom.product-list-item').each(function() {
      var $item = jQuery(this);
      var id = $item.data('product-id') || $item.find('[data-product-id]').attr('data-product-id') || '';
      var price = $item.find('.price, .cart-product-price, .mini-bag-product-price').first().text().replace(/[^\d\.,]/g, '').replace(',', '') || '';
      var qty = $item.find('.quantity, .mini-bag-product-qty, .cart-product-qty').first().text().trim();
      if (!qty) qty = $item.find('input.qty, input.quantity').val();
      if (id) {
        items.push({
          item: id,
          price: parseFloat(price) || 0,
          quantity: parseInt(qty, 10) || 1
        });
      }
    });
    return items;
  }

  // --- Show/hide cart button if cart is nonempty ---
  function updateButtonVisibility() {
    var btn = document.getElementById(buttonId);
    var html = extractCartItemsUniversal();
    if (html) {
      btn.style.display = 'block';
    } else {
      btn.style.display = 'none';
      var popup = document.getElementById(popupId);
      if (popup) popup.style.display = 'none';
    }
  }

  // --- Live update via MutationObserver ---
  function observeCartChanges() {
    var magentoMiniCart = document.querySelector('ol.minicart-items');
    if (magentoMiniCart) {
      var observer1 = new MutationObserver(updateButtonVisibility);
      observer1.observe(magentoMiniCart, { childList: true, subtree: true });
    }
    var sfccCartList = document.querySelector('.product-list-item-custom.product-list-item');
    if (sfccCartList) {
      var observer2 = new MutationObserver(updateButtonVisibility);
      observer2.observe(sfccCartList.parentNode, { childList: true, subtree: true });
    }
    var sfccMiniCart = document.querySelector('.mini-cart-product, .mini-bag-product');
    if (sfccMiniCart) {
      var observer3 = new MutationObserver(updateButtonVisibility);
      observer3.observe(sfccMiniCart.parentNode, { childList: true, subtree: true });
    }
    updateButtonVisibility(); // Initial check
  }

  // --- Popup open/close logic ---
  document.getElementById(buttonId).onclick = function() {
    var popup = document.getElementById(popupId);
    if (popup.style.display === 'block') {
      popup.style.display = 'none';
    } else {
      var html = extractCartItemsUniversal();
      document.getElementById(listId).innerHTML = html || '<li>No cart items found.</li>';
      popup.style.display = 'block';
      showViewerInPopup();
      document.getElementById(recsContainerId).style.display = 'none';
      document.getElementById(recsButtonId).textContent = 'Show Cart Recs';
    }
  };
  document.getElementById(closeId).onclick = function() {
    document.getElementById(popupId).style.display = 'none';
  };
  document.addEventListener('mousedown', function(e) {
    var popup = document.getElementById(popupId);
    var btn = document.getElementById(buttonId);
    if (popup.style.display === 'block' && !popup.contains(e.target) && e.target !== btn) {
      popup.style.display = 'none';
    }
  });

  // --- Cart recs button logic: always show recs, always push cart or fallback to [] ---
  document.getElementById(recsButtonId).onclick = function() {
    var recsDiv = document.getElementById(recsContainerId);
    var recsBtn = document.getElementById(recsButtonId);

    if (recsDiv.style.display === 'block') {
      recsDiv.style.display = 'none';
      recsBtn.textContent = 'Show Cart Recs';
    } else {
      recsDiv.style.display = 'block';
      recsBtn.textContent = 'Hide Cart Recs';

      // 1. Try to extract real cart items
      var cartItems = extractCartItemsForScarab();
      // 2. If none found, use empty array to trigger fallback recs
      if (!Array.isArray(cartItems) || !cartItems.length) cartItems = [];
      console.log('[Cart Recs] Sending cart items:', cartItems);

      if (typeof ScarabQueue !== 'undefined') {
        ScarabQueue.push(['cart', cartItems]);
        ScarabQueue.push(['recommend', {
          logic: 'CART',
          containerId: recsContainerId,
          templateId: recsTemplateId,
          limit: '8'
        }]);
        ScarabQueue.push(['go']);
      } else {
        recsDiv.innerHTML = '<div style="color:#888;font-size:13px;">(No recommendations available)</div>';
      }
    }
  };

  // --- DOM Ready ---
  if (document.readyState !== 'loading') {
    observeCartChanges();
  } else {
    document.addEventListener('DOMContentLoaded', observeCartChanges);
  }
})();
</script>